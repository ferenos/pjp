name: Build Modpack Pack

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allows manual trigger

env:
  MC_VERSION: "1.20.1"
  FORGE_VERSION: "47.4.12"
  JAVA_VERSION: "17"
  SERVER_MEMORY_MAX: "16G"
  SERVER_MEMORY_MIN: "4G"
  SERVER_STARTUP_TIMEOUT: "120"

jobs:
  ensure-repo-owner-triggered-if-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Check if repository owner triggered the workflow
        run: |
          if [ "${{ github.repository_owner }}" != "${{ github.actor }}" ]; then
            echo "This workflow can only be manually triggered by the repository owner (${{
            github.repository_owner }})."
            exit 1
          else
            echo "Workflow manually triggered by repository owner. Continuing..."
          fi
  version-check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Pack.toml version has bumped
        id: extract_version
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          CURRENT_VERSION=$(grep '^version = ' pack.toml | sed 's/version = "\(.*\)"/\1/')
          
          echo "VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, skipping version check."
            exit 0
          fi
          
          LATEST_VERSION=${LATEST_TAG#v}
          
          echo "Latest tagged version: $LATEST_VERSION"
          echo "Current pack.toml version: $CURRENT_VERSION"
          
          if [ "$CURRENT_VERSION" == "$LATEST_VERSION" ]; then
            echo "Error: pack.toml version has not been bumped since the last release."
            exit 1
          else
            echo "Version check passed: pack.toml version has been updated."
          fi

  build-server:
    needs: [version-check]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    env:
      BUILD_VERSION: ${{ needs.version-check.outputs.version }}
    
    steps:      
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download Forge Installer
        run: |
          wget -q https://maven.minecraftforge.net/net/minecraftforge/forge/${MC_VERSION}-${FORGE_VERSION}/forge-${MC_VERSION}-${FORGE_VERSION}-installer.jar
          java -jar forge-${MC_VERSION}-${FORGE_VERSION}-installer.jar --installServer

      - name: Create server directory structure
        run: |
          mkdir -p server-pack
          
          # Copy Forge server files
          cp -r libraries server-pack/
          cp forge-*.jar server-pack/ || cp server.jar server-pack/
          
          # Copy packwiz files
          cp pack.toml server-pack/
          cp index.toml server-pack/
          cp setup/packwiz-installer-bootstrap.jar server-pack/
          cp setup/packwiz-installer.jar server-pack/
          
          # Copy server configs (kubejs, config, etc)
          if [ -d "config" ]; then
            cp -r config server-pack/
          fi
          
          if [ -d "kubejs" ]; then
            cp -r kubejs server-pack/
          fi
          
          if [ -d "defaultconfigs" ]; then
            cp -r defaultconfigs server-pack/
          fi
      
      - name: Create startup scripts
        run: |
          # Linux startup script
          cat > server-pack/start-server.sh << 'EOF'
          #!/bin/bash
          echo "Starting Minecraft modded server with Packwiz..."
          echo "This will download all mods automatically on first run."
          echo ""
          
          # First run packwiz-installer-bootstrap to download mods
          java -jar packwiz-installer-bootstrap.jar -s server
          
          # Then start the server with Aikar's flags
          java -Xms4G -Xmx8G \
          -XX:+UseG1GC \
          -XX:+ParallelRefProcEnabled \
          -XX:MaxGCPauseMillis=200 \
          -XX:+UnlockExperimentalVMOptions \
          -XX:+DisableExplicitGC \
          -XX:+AlwaysPreTouch \
          -XX:G1NewSizePercent=30 \
          -XX:G1MaxNewSizePercent=40 \
          -XX:G1HeapRegionSize=8M \
          -XX:G1ReservePercent=20 \
          -XX:G1HeapWastePercent=5 \
          -XX:G1MixedGCCountTarget=4 \
          -XX:InitiatingHeapOccupancyPercent=15 \
          -XX:G1MixedGCLiveThresholdPercent=90 \
          -XX:G1RSetUpdatingPauseTimePercent=5 \
          -XX:SurvivorRatio=32 \
          -XX:+PerfDisableSharedMem \
          -XX:MaxTenuringThreshold=1 \
          -Dusing.aikars.flags=https://mcflags.emc.gs \
          -Daikars.new.flags=true \
          -jar forge-*.jar nogui
          EOF
          
          chmod +x server-pack/start-server.sh
          
          # Windows startup script
          cat > server-pack/start-server.bat << 'EOF'
          @echo off
          title Minecraft Modded Server
          echo Starting server with Packwiz...
          echo This will download all mods automatically on first run.
          echo.
          
          REM First run packwiz-installer-bootstrap to download mods
          java -jar packwiz-installer-bootstrap.jar -s server
          
          REM Then start the server
          java -Xms4G -Xmx8G ^
          -XX:+UseG1GC ^
          -XX:+ParallelRefProcEnabled ^
          -XX:MaxGCPauseMillis=200 ^
          -XX:+UnlockExperimentalVMOptions ^
          -XX:+DisableExplicitGC ^
          -XX:+AlwaysPreTouch ^
          -XX:G1NewSizePercent=30 ^
          -XX:G1MaxNewSizePercent=40 ^
          -XX:G1HeapRegionSize=8M ^
          -XX:G1ReservePercent=20 ^
          -XX:G1HeapWastePercent=5 ^
          -XX:G1MixedGCCountTarget=4 ^
          -XX:InitiatingHeapOccupancyPercent=15 ^
          -XX:G1MixedGCLiveThresholdPercent=90 ^
          -XX:G1RSetUpdatingPauseTimePercent=5 ^
          -XX:SurvivorRatio=32 ^
          -XX:+PerfDisableSharedMem ^
          -XX:MaxTenuringThreshold=1 ^
          -Dusing.aikars.flags=https://mcflags.emc.gs ^
          -Daikars.new.flags=true ^
          -jar forge-1.20.1-47.4.12.jar nogui
          
          pause
          EOF
      
      - name: Create README for server
        run: |
          cat > server-pack/README.md << 'EOF'
          # Server Pack Installation
          
          ## What's Included
          This server pack uses **Packwiz Bootstrap** to automatically download mods on first run.
          
          Included files:
          - Forge server (libraries + forge jar)
          - `pack.toml` and `index.toml` - Packwiz modpack definitions
          - `packwiz-installer-bootstrap.jar` - Auto-downloads mods from pack.toml
          - `packwiz-installer.jar` - Mod installer
          - Server configs (kubejs, config files)
          - Start scripts (Linux & Windows)
          
          ## Requirements
          - Java 17 or higher
          - 8GB RAM minimum (recommended)
          - Ubuntu/Debian Linux or Windows Server
          
          ## Quick Start
          
          ### Linux
          ```bash
          # Extract the zip
          unzip server-pack-*.zip
          cd server-pack
          
          # Run the server (mods will auto-download on first run)
          ./start-server.sh
          
          # On first run, accept the EULA
          # Edit eula.txt and set: eula=true
          
          # Start again
          ./start-server.sh
          ```
          
          ### Windows
          1. Extract the zip file
          2. Double-click `start-server.bat`
          3. Wait for mods to download automatically
          4. Server will create `eula.txt` and stop
          5. Edit `eula.txt` and set `eula=true`
          6. Run `start-server.bat` again
          
          ## How It Works
          
          The packwiz-installer-bootstrap will:
          1. Read `pack.toml` and `index.toml`
          2. Download all mods from Modrinth/CurseForge automatically
          3. Place them in the `mods/` folder
          4. Keep mods updated if you update the pack files
          
          ## Configuration
          
          - **Memory**: Edit the start scripts to adjust `-Xms4G -Xmx8G` values
          - **Server settings**: Edit `server.properties` after first run
          - **Port**: Default 25565 (change in `server.properties`)
          
          ## Updating the Modpack
          
          To update to a new version:
          1. Download the new server pack
          2. Replace `pack.toml` and `index.toml` 
          3. Restart server - packwiz will update mods automatically
          
          ## Manual Mod Download (Optional)
          
          If you prefer to pre-download mods instead of auto-download:
          ```bash
          java -jar packwiz-installer.jar -s server
          ```
          
          ## World Pre-generation (Recommended)
          
          For better performance:
          1. Start server normally
          2. Run: `/chunky world world`
          3. Run: `/chunky radius 5000`
          4. Run: `/chunky start`
          5. Wait 1-3 hours for completion
          
          ## Support
          Report issues: https://github.com/${{ github.repository }}/issues
          EOF
      
      - name: Create systemd service file
        run: |
          cat > server-pack/minecraft.service << 'EOF'
          [Unit]
          Description=Minecraft Modded Server
          After=network.target
          
          [Service]
          Type=simple
          User=minecraft
          WorkingDirectory=/home/minecraft/server
          ExecStart=/home/minecraft/server/start-server.sh
          Restart=on-failure
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create server pack archive
        run: |
          cd server-pack
          zip -r ../server-pack-${{ steps.get_version.outputs.VERSION }}.zip .
          cd ..
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            # Get commits since last tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            else
              CHANGELOG=$(git log --pretty=format:"- %s" --no-merges -n 10)
            fi
          else
            CHANGELOG="Development build from commit $(git rev-parse --short HEAD)"
          fi
          
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: server-pack-*.zip
          body: |
            ## Server Pack Release ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            1. Download `server-pack-${{ steps.get_version.outputs.VERSION }}.zip`
            2. Extract to your server directory
            3. Follow instructions in README.md
            
            ### Changes
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### Requirements
            - Java 17+
            - 8GB RAM minimum
            - Forge 1.20.1-47.4.12
            
            ### Mods Included
            See [pack.toml](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/pack.toml) for full mod list
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact (for non-tag builds)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: server-pack-${{ steps.get_version.outputs.VERSION }}
          path: server-pack-*.zip
          retention-days: 5

  build-client:
    needs: [version-check, build-server]
    runs-on: ubuntu-latest
    env:
      BUILD_VERSION: ${{ needs.version-check.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GO
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      
      - name: Install Packwiz
        run: |
          go install github.com/packwiz/packwiz@latest

      - name: Copy from Manual to Packwiz Cache
        run: |
          mkdir -p /home/runner/.cache/packwiz/cache/import
          cp -r manual_mods/* /home/runner/.cache/packwiz/cache/import
    
      - name: Create Modrinth Export
        run: |
          packwiz modrinth export

      - name: Upload Modrinth Pack
        uses: actions/upload-artifact@v4
        with:
          name: NutAndJamPack-${{ env.BUILD_VERSION }}.mrpack
          path: NutAndJamPack-${{ env.BUILD_VERSION }}.mrpack
          retention-days: 5

  release:
    needs: [version-check, build-server, build-client]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      BUILD_VERSION: ${{ needs.version-check.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download server artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-pack-${{ needs.build-server.outputs.version }}
          path: ./artifacts/server
      
      - name: Download client artifacts
        uses: actions/download-artifact@v4
        with:
          name: NutAndJamPack ${{ needs.version-check.outputs.version }}-${{ needs.version-check.outputs.version }}.mrpack
          path: ./artifacts/client
      
      - name: Prepare release files
        run: |
          # List downloaded files for debugging
          echo "Server artifacts:"
          ls -lah ./artifacts/server/
          echo "Client artifacts:"
          ls -lah ./artifacts/client/
          
          # Move files to root for easier upload
          mkdir -p ./release-files
          find ./artifacts -type f -exec mv {} ./release-files/ \;
          
          echo "Release files:"
          ls -lah ./release-files/
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -n 10)
          fi
          
          # If no commits, use default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi
          
          # Save to file for multi-line support
          echo "$CHANGELOG" > changelog.txt
          
          echo "Generated changelog:"
          cat changelog.txt
      
      - name: Create and push tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          TAG="v${{ env.BUILD_VERSION }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, deleting it"
            git tag -d "$TAG"
            git push origin ":refs/tags/$TAG" || true
          fi
          
          # Create new tag
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          echo "Created and pushed tag: $TAG"
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ env.BUILD_VERSION }}"
          
          # Create release notes
          cat > release-notes.md << 'EOF'
          ## Modpack ${{ env.BUILD_VERSION }}
          
          ### Downloads
          - **Server Pack**: `server-pack-*.zip` - For dedicated servers
          - **Client Pack**: `NutAndJamPack-*.mrpack` - For Prism Launcher / Modrinth App
          
          ### Changes
          EOF
          
          cat changelog.txt >> release-notes.md
          
          cat >> release-notes.md << 'EOF'
          
          ### Requirements
          - **Minecraft**: 1.20.1
          - **Forge**: 47.4.12
          - **Java**: 17 or higher
          - **RAM**: 4GB minimum (8GB recommended)
          
            ### Installation
            
            #### Client (Prism Launcher)
            1. Download `NutAndJamPack-*.mrpack`
            2. Open Modrinth Launcher
            3. Click "Add Instance" â†’ "Import from zip"
            4. Select the downloaded `.mrpack` file
            
            #### Server
            1. Download `server-pack-*.zip`
            2. Extract to your server directory
            3. Run `start-server.sh` (Linux) or `start-server.bat` (Windows)
            4. Mods will download automatically on first run
            5. Accept EULA by editing `eula.txt` and setting `eula=true`
            6. Configure `server.properties` as needed
            7. Restart server
            
            **Note**: The server uses Packwiz Bootstrap to automatically download all mods from the modpack definition. No manual mod downloads required!          ### Report Issues
          Found a bug? [Open an issue](https://github.com/${{ github.repository }}/issues)
          EOF
          
          echo "Release notes:"
          cat release-notes.md
          
          # Create release with all files in release-files directory
          gh release create "$TAG" \
            ./release-files/* \
            --title "NutAndJam Modpack ${{ env.BUILD_VERSION }}" \
            --notes-file release-notes.md \
            --latest

  publish-release-message:
    needs: [version-check, release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      BUILD_VERSION: ${{ needs.version-check.outputs.version }}
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate mod changelog
        id: mod_changelog
        run: |
          chmod +x scripts/mod_changelog.sh
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="v${{ env.BUILD_VERSION }}"
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using initial release message"
            echo "CHANGELOG=Initial release of NutAndJam Modpack!" >> $GITHUB_OUTPUT
          else
            # Run the changelog script
            export GITHUB_REPOSITORY="${{ github.repository }}"
            ./scripts/mod_changelog.sh "$PREV_TAG" "$CURRENT_TAG"
            
            # Read the generated changelog
            CHANGELOG_CONTENT=$(cat CHANGELOG-${CURRENT_TAG}.md)
            
            # Save to output (escaping for multiline)
            {
              echo 'CHANGELOG<<EOF'
              echo "$CHANGELOG_CONTENT"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_TAG: "v${{ env.BUILD_VERSION }}"
          RELEASE_NAME: "NutAndJam Modpack ${{ env.BUILD_VERSION }}"
          RELEASE_URL: "${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ env.BUILD_VERSION }}"
          RELEASE_BODY: "${{ steps.mod_changelog.outputs.CHANGELOG }}"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_WEBHOOK_USERNAME: "NutAndJam Modpack"
        run: |
          python discord/post_release_to_discord.py